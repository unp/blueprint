/*
 * Copyright 2015 Palantir Technologies, Inc. All rights reserved.
 * Licensed under the BSD-3 License as modified (the “License”); you may obtain a copy
 * of the license at https://github.com/palantir/blueprint/blob/master/LICENSE
 * and https://github.com/palantir/blueprint/blob/master/PATENTS
 */
"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var core_1 = require("@blueprintjs/core");
var classNames = require("classnames");
var React = require("react");
var ReactDayPicker = require("react-day-picker");
var Classes = require("./common/classes");
var DateUtils = require("./common/dateUtils");
var Errors = require("./common/errors");
var datePickerCaption_1 = require("./datePickerCaption");
var datePickerCore_1 = require("./datePickerCore");
var DatePicker = (function (_super) {
    __extends(DatePicker, _super);
    function DatePicker(props, context) {
        var _this = this;
        _super.call(this, props, context);
        this.displayName = "Blueprint.DatePicker";
        this.ignoreNextMonthChange = false;
        this.disabledDays = function (day) { return !DateUtils.isDayInRange(day, [_this.props.minDate, _this.props.maxDate]); };
        this.selectedDays = function (day) { return DateUtils.areSameDay(_this.state.value, day); };
        this.handleDayClick = function (_e, day, modifiers) {
            var newValue = day;
            if (_this.props.canClearSelection && modifiers.selected) {
                newValue = null;
            }
            if (_this.props.value === undefined) {
                // component is uncontrolled
                if (!modifiers.disabled) {
                    var displayMonth = day.getMonth();
                    var displayYear = day.getFullYear();
                    var selectedDay = day.getDate();
                    _this.setState({ displayMonth: displayMonth, displayYear: displayYear, selectedDay: selectedDay, value: newValue });
                }
            }
            if (!modifiers.disabled) {
                core_1.Utils.safeInvoke(_this.props.onChange, newValue, true);
                if (_this.state.value != null && _this.state.value.getMonth() !== day.getMonth()) {
                    _this.ignoreNextMonthChange = true;
                }
            }
            else {
                // rerender base component to get around bug where you can navigate past bounds by clicking days
                _this.forceUpdate();
            }
        };
        this.handleMonthChange = function (newDate) {
            var displayMonth = newDate.getMonth();
            var displayYear = newDate.getFullYear();
            var value = _this.state.value;
            if (value !== null) {
                value = _this.computeValidDateInSpecifiedMonthYear(displayYear, displayMonth);
                if (_this.ignoreNextMonthChange) {
                    _this.ignoreNextMonthChange = false;
                }
                else {
                    // if handleDayClick just got run, it means the user selected a date in a new month,
                    // so don't run onChange again
                    core_1.Utils.safeInvoke(_this.props.onChange, value, false);
                }
            }
            _this.setStateWithValueIfUncontrolled({ displayMonth: displayMonth, displayYear: displayYear }, value);
        };
        this.handleMonthSelectChange = function (displayMonth) {
            var value = _this.state.value;
            if (value !== null) {
                value = _this.computeValidDateInSpecifiedMonthYear(value.getFullYear(), displayMonth);
                core_1.Utils.safeInvoke(_this.props.onChange, value, false);
            }
            _this.setStateWithValueIfUncontrolled({ displayMonth: displayMonth }, value);
        };
        this.handleYearSelectChange = function (displayYear) {
            var _a = _this.state, displayMonth = _a.displayMonth, value = _a.value;
            if (value !== null) {
                value = _this.computeValidDateInSpecifiedMonthYear(displayYear, displayMonth);
                core_1.Utils.safeInvoke(_this.props.onChange, value, false);
                displayMonth = value.getMonth();
            }
            else {
                var _b = _this.props, minDate = _b.minDate, maxDate = _b.maxDate;
                var minYear = minDate.getFullYear();
                var maxYear = maxDate.getFullYear();
                var minMonth = minDate.getMonth();
                var maxMonth = maxDate.getMonth();
                if (displayYear === minYear && displayMonth < minMonth) {
                    displayMonth = minMonth;
                }
                else if (displayYear === maxYear && displayMonth > maxMonth) {
                    displayMonth = maxMonth;
                }
            }
            _this.setStateWithValueIfUncontrolled({ displayMonth: displayMonth, displayYear: displayYear }, value);
        };
        this.handleClearClick = function () {
            if (_this.props.value === undefined) {
                _this.setState({ value: null });
            }
            core_1.Utils.safeInvoke(_this.props.onChange, null, true);
        };
        this.handleTodayClick = function () {
            var value = new Date();
            var displayMonth = value.getMonth();
            var displayYear = value.getFullYear();
            var selectedDay = value.getDate();
            if (_this.props.value === undefined) {
                _this.setState({ displayMonth: displayMonth, displayYear: displayYear, selectedDay: selectedDay, value: value });
            }
            else {
                _this.setState({ displayMonth: displayMonth, displayYear: displayYear, selectedDay: selectedDay });
            }
            core_1.Utils.safeInvoke(_this.props.onChange, value, true);
        };
        var value = null;
        if (props.value !== undefined) {
            value = props.value;
        }
        else if (props.defaultValue != null) {
            value = props.defaultValue;
        }
        var selectedDay;
        if (value !== null) {
            selectedDay = value.getDate();
        }
        var initialMonth;
        var today = new Date();
        if (props.initialMonth != null) {
            initialMonth = props.initialMonth;
        }
        else if (value != null) {
            initialMonth = value;
        }
        else if (DateUtils.isDayInRange(today, [props.minDate, props.maxDate])) {
            initialMonth = today;
        }
        else {
            initialMonth = DateUtils.getDateBetween([props.minDate, props.maxDate]);
        }
        this.state = {
            displayMonth: initialMonth.getMonth(),
            displayYear: initialMonth.getFullYear(),
            selectedDay: selectedDay,
            value: value,
        };
    }
    DatePicker.prototype.render = function () {
        var _a = this.props, className = _a.className, locale = _a.locale, localeUtils = _a.localeUtils, maxDate = _a.maxDate, minDate = _a.minDate, showActionsBar = _a.showActionsBar;
        var _b = this.state, displayMonth = _b.displayMonth, displayYear = _b.displayYear;
        return (React.createElement("div", {className: classNames(Classes.DATEPICKER, className)}, 
            React.createElement(ReactDayPicker, {canChangeMonth: true, captionElement: this.renderCaption(), disabledDays: this.disabledDays, enableOutsideDays: true, fromMonth: minDate, initialMonth: new Date(displayYear, displayMonth), locale: locale, localeUtils: localeUtils, modifiers: this.props.modifiers, onDayClick: this.handleDayClick, onMonthChange: this.handleMonthChange, selectedDays: this.selectedDays, toMonth: maxDate}), 
            showActionsBar ? this.renderOptionsBar() : null));
    };
    DatePicker.prototype.componentWillReceiveProps = function (nextProps) {
        if (nextProps.value !== this.props.value) {
            var _a = this.state, displayMonth = _a.displayMonth, displayYear = _a.displayYear, selectedDay = _a.selectedDay;
            if (nextProps.value != null) {
                displayMonth = nextProps.value.getMonth();
                displayYear = nextProps.value.getFullYear();
                selectedDay = nextProps.value.getDate();
            }
            this.setState({ displayMonth: displayMonth, displayYear: displayYear, selectedDay: selectedDay, value: nextProps.value });
        }
        _super.prototype.componentWillReceiveProps.call(this, nextProps);
    };
    DatePicker.prototype.validateProps = function (props) {
        var defaultValue = props.defaultValue, initialMonth = props.initialMonth, maxDate = props.maxDate, minDate = props.minDate, value = props.value;
        if (defaultValue != null && !DateUtils.isDayInRange(defaultValue, [minDate, maxDate])) {
            throw new Error(Errors.DATEPICKER_DEFAULT_VALUE_INVALID);
        }
        if (initialMonth != null && !DateUtils.isMonthInRange(initialMonth, [minDate, maxDate])) {
            throw new Error(Errors.DATEPICKER_INITIAL_MONTH_INVALID);
        }
        if (maxDate != null
            && minDate != null
            && maxDate < minDate
            && !DateUtils.areSameDay(maxDate, minDate)) {
            throw new Error(Errors.DATEPICKER_MAX_DATE_INVALID);
        }
        if (value != null && !DateUtils.isDayInRange(value, [minDate, maxDate])) {
            throw new Error(Errors.DATEPICKER_VALUE_INVALID);
        }
    };
    DatePicker.prototype.renderCaption = function () {
        var _a = this.props, maxDate = _a.maxDate, minDate = _a.minDate;
        return (React.createElement(datePickerCaption_1.DatePickerCaption, {maxDate: maxDate, minDate: minDate, onMonthChange: this.handleMonthSelectChange, onYearChange: this.handleYearSelectChange}));
    };
    DatePicker.prototype.renderOptionsBar = function () {
        return (React.createElement("div", {className: Classes.DATEPICKER_FOOTER}, 
            React.createElement(core_1.Button, {className: "pt-minimal pt-datepicker-footer-button", onClick: this.handleTodayClick, text: "Today"}), 
            React.createElement(core_1.Button, {className: "pt-minimal pt-datepicker-footer-button", onClick: this.handleClearClick, text: "Clear"})));
    };
    DatePicker.prototype.computeValidDateInSpecifiedMonthYear = function (displayYear, displayMonth) {
        var _a = this.props, minDate = _a.minDate, maxDate = _a.maxDate;
        var maxDaysInMonth = new Date(displayYear, displayMonth + 1, 0).getDate();
        var selectedDay = this.state.selectedDay;
        if (selectedDay > maxDaysInMonth) {
            selectedDay = maxDaysInMonth;
        }
        // matches the underlying react-day-picker timestamp behavior
        var value = new Date(displayYear, displayMonth, selectedDay, 12);
        if (value < minDate) {
            value = minDate;
        }
        else if (value > maxDate) {
            value = maxDate;
        }
        return value;
    };
    DatePicker.prototype.setStateWithValueIfUncontrolled = function (newState, value) {
        if (this.props.value === undefined) {
            // uncontrolled mode means we track value in state
            newState.value = value;
        }
        return this.setState(newState);
    };
    DatePicker.defaultProps = {
        canClearSelection: true,
        maxDate: datePickerCore_1.getDefaultMaxDate(),
        minDate: datePickerCore_1.getDefaultMinDate(),
        showActionsBar: false,
    };
    return DatePicker;
}(core_1.AbstractComponent));
exports.DatePicker = DatePicker;
exports.DatePickerFactory = React.createFactory(DatePicker);

//# sourceMappingURL=data:application/json;base64,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a0RBQWtEO1lBQ2xELFFBQVEsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQzNCLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBdlBhLHVCQUFZLEdBQXFCO1FBQzNDLGlCQUFpQixFQUFFLElBQUk7UUFDdkIsT0FBTyxFQUFFLGtDQUFpQixFQUFFO1FBQzVCLE9BQU8sRUFBRSxrQ0FBaUIsRUFBRTtRQUM1QixjQUFjLEVBQUUsS0FBSztLQUN4QixDQUFDO0lBdVFOLGlCQUFDO0FBQUQsQ0E3UUEsQUE2UUMsQ0E3UStCLHdCQUFpQixHQTZRaEQ7QUE3UVksa0JBQVUsYUE2UXRCLENBQUE7QUFFWSx5QkFBaUIsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDIiwiZmlsZSI6ImRhdGVQaWNrZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTUgUGFsYW50aXIgVGVjaG5vbG9naWVzLCBJbmMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQlNELTMgTGljZW5zZSBhcyBtb2RpZmllZCAodGhlIOKAnExpY2Vuc2XigJ0pOyB5b3UgbWF5IG9idGFpbiBhIGNvcHlcbiAqIG9mIHRoZSBsaWNlbnNlIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS9wYWxhbnRpci9ibHVlcHJpbnQvYmxvYi9tYXN0ZXIvTElDRU5TRVxuICogYW5kIGh0dHBzOi8vZ2l0aHViLmNvbS9wYWxhbnRpci9ibHVlcHJpbnQvYmxvYi9tYXN0ZXIvUEFURU5UU1xuICovXG5cbmltcG9ydCB7IEFic3RyYWN0Q29tcG9uZW50LCBCdXR0b24sIElQcm9wcywgVXRpbHMgfSBmcm9tIFwiQGJsdWVwcmludGpzL2NvcmVcIjtcbmltcG9ydCAqIGFzIGNsYXNzTmFtZXMgZnJvbSBcImNsYXNzbmFtZXNcIjtcbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gXCJyZWFjdFwiO1xuaW1wb3J0ICogYXMgUmVhY3REYXlQaWNrZXIgZnJvbSBcInJlYWN0LWRheS1waWNrZXJcIjtcblxuaW1wb3J0ICogYXMgQ2xhc3NlcyBmcm9tIFwiLi9jb21tb24vY2xhc3Nlc1wiO1xuaW1wb3J0ICogYXMgRGF0ZVV0aWxzIGZyb20gXCIuL2NvbW1vbi9kYXRlVXRpbHNcIjtcbmltcG9ydCAqIGFzIEVycm9ycyBmcm9tIFwiLi9jb21tb24vZXJyb3JzXCI7XG5cbmltcG9ydCB7IERhdGVQaWNrZXJDYXB0aW9uIH0gZnJvbSBcIi4vZGF0ZVBpY2tlckNhcHRpb25cIjtcbmltcG9ydCB7XG4gICAgZ2V0RGVmYXVsdE1heERhdGUsXG4gICAgZ2V0RGVmYXVsdE1pbkRhdGUsXG4gICAgSURhdGVQaWNrZXJCYXNlUHJvcHMsXG4gICAgSURhdGVQaWNrZXJEYXlNb2RpZmllcnMsXG59IGZyb20gXCIuL2RhdGVQaWNrZXJDb3JlXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSURhdGVQaWNrZXJQcm9wcyBleHRlbmRzIElEYXRlUGlja2VyQmFzZVByb3BzLCBJUHJvcHMge1xuICAgLyoqXG4gICAgKiBBbGxvd3MgdGhlIHVzZXIgdG8gY2xlYXIgdGhlIHNlbGVjdGlvbiBieSBjbGlja2luZyB0aGUgY3VycmVudGx5IHNlbGVjdGVkIGRheS5cbiAgICAqL1xuICAgIGNhbkNsZWFyU2VsZWN0aW9uPzogYm9vbGVhbjtcblxuICAgLyoqXG4gICAgKiBJbml0aWFsIGRheSB0aGUgY2FsZW5kYXIgd2lsbCBkaXNwbGF5IGFzIHNlbGVjdGVkLlxuICAgICogVGhpcyBzaG91bGQgbm90IGJlIHNldCBpZiBgdmFsdWVgIGlzIHNldC5cbiAgICAqL1xuICAgIGRlZmF1bHRWYWx1ZT86IERhdGU7XG5cbiAgIC8qKlxuICAgICogQ2FsbGVkIHdoZW4gdGhlIHVzZXIgc2VsZWN0cyBhIGRheS5cbiAgICAqIElmIGJlaW5nIHVzZWQgaW4gYW4gdW5jb250cm9sbGVkIG1hbm5lciwgYHNlbGVjdGVkRGF0ZWAgd2lsbCBiZSBgbnVsbGAgaWYgdGhlIHVzZXIgY2xpY2tzIHRoZSBjdXJyZW50bHkgc2VsZWN0ZWRcbiAgICAqIGRheS4gSWYgYmVpbmcgdXNlZCBpbiBhIGNvbnRyb2xsZWQgbWFubmVyLCBgc2VsZWN0ZWREYXRlYCB3aWxsIGNvbnRhaW4gdGhlIGRheSBjbGlja2VkIG5vIG1hdHRlciB3aGF0LlxuICAgICogYGhhc1VzZXJNYW51YWxseVNlbGVjdGVkRGF0ZWAgaXMgdHJ1ZSBpZiB0aGUgdXNlciBzZWxlY3RlZCBhIGRheSwgYW5kIGZhbHNlIGlmIHRoZSBkYXRlIHdhcyBhdXRvbWF0aWNhbGx5IGNoYW5nZWRcbiAgICAqIGJ5IHRoZSB1c2VyIG5hdmlnYXRpbmcgdG8gYSBuZXcgbW9udGggb3IgeWVhciByYXRoZXIgdGhhbiBleHBsaWNpdGx5IGNsaWNraW5nIG9uIGEgZGF0ZSBpbiB0aGUgY2FsZW5kYXIuXG4gICAgKi9cbiAgICBvbkNoYW5nZT86IChzZWxlY3RlZERhdGU6IERhdGUsIGhhc1VzZXJNYW51YWxseVNlbGVjdGVkRGF0ZTogYm9vbGVhbikgPT4gdm9pZDtcblxuICAgLyoqXG4gICAgKiBXaGV0aGVyIHRoZSBib3R0b20gYmFyIGRpc3BsYXlpbmcgJ1RvZGF5JyBhbmQgJ0NsZWFyJyBidXR0b25zIHNob3VsZCBiZSBzaG93bi5cbiAgICAqIEBkZWZhdWx0IGZhbHNlXG4gICAgKi9cbiAgICBzaG93QWN0aW9uc0Jhcj86IGJvb2xlYW47XG5cbiAgIC8qKlxuICAgICogVGhlIGN1cnJlbnRseSBzZWxlY3RlZCBkYXkuIElmIHRoaXMgcHJvcCBpcyBwcmVzZW50LCB0aGUgY29tcG9uZW50IGFjdHMgaW4gYSBjb250cm9sbGVkIG1hbm5lci5cbiAgICAqL1xuICAgIHZhbHVlPzogRGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJRGF0ZVBpY2tlclN0YXRlIHtcbiAgICBkaXNwbGF5TW9udGg/OiBudW1iZXI7XG4gICAgZGlzcGxheVllYXI/OiBudW1iZXI7XG4gICAgc2VsZWN0ZWREYXk/OiBudW1iZXI7XG4gICAgdmFsdWU/OiBEYXRlO1xufVxuXG5leHBvcnQgY2xhc3MgRGF0ZVBpY2tlciBleHRlbmRzIEFic3RyYWN0Q29tcG9uZW50PElEYXRlUGlja2VyUHJvcHMsIElEYXRlUGlja2VyU3RhdGU+IHtcbiAgICBwdWJsaWMgc3RhdGljIGRlZmF1bHRQcm9wczogSURhdGVQaWNrZXJQcm9wcyA9IHtcbiAgICAgICAgY2FuQ2xlYXJTZWxlY3Rpb246IHRydWUsXG4gICAgICAgIG1heERhdGU6IGdldERlZmF1bHRNYXhEYXRlKCksXG4gICAgICAgIG1pbkRhdGU6IGdldERlZmF1bHRNaW5EYXRlKCksXG4gICAgICAgIHNob3dBY3Rpb25zQmFyOiBmYWxzZSxcbiAgICB9O1xuXG4gICAgcHVibGljIGRpc3BsYXlOYW1lID0gXCJCbHVlcHJpbnQuRGF0ZVBpY2tlclwiO1xuXG4gICAgcHJpdmF0ZSBpZ25vcmVOZXh0TW9udGhDaGFuZ2UgPSBmYWxzZTtcblxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcm9wcz86IElEYXRlUGlja2VyUHJvcHMsIGNvbnRleHQ/OiBhbnkpIHtcbiAgICAgICAgc3VwZXIocHJvcHMsIGNvbnRleHQpO1xuXG4gICAgICAgIGxldCB2YWx1ZTogRGF0ZSA9IG51bGw7XG4gICAgICAgIGlmIChwcm9wcy52YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IHByb3BzLnZhbHVlO1xuICAgICAgICB9IGVsc2UgaWYgKHByb3BzLmRlZmF1bHRWYWx1ZSAhPSBudWxsKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IHByb3BzLmRlZmF1bHRWYWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBzZWxlY3RlZERheTogbnVtYmVyO1xuICAgICAgICBpZiAodmFsdWUgIT09IG51bGwpIHsgc2VsZWN0ZWREYXkgPSB2YWx1ZS5nZXREYXRlKCk7IH1cblxuICAgICAgICBsZXQgaW5pdGlhbE1vbnRoOiBEYXRlO1xuICAgICAgICBjb25zdCB0b2RheSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIGlmIChwcm9wcy5pbml0aWFsTW9udGggIT0gbnVsbCkge1xuICAgICAgICAgICAgaW5pdGlhbE1vbnRoID0gcHJvcHMuaW5pdGlhbE1vbnRoO1xuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICE9IG51bGwpIHtcbiAgICAgICAgICAgIGluaXRpYWxNb250aCA9IHZhbHVlO1xuICAgICAgICB9IGVsc2UgaWYgKERhdGVVdGlscy5pc0RheUluUmFuZ2UodG9kYXksIFtwcm9wcy5taW5EYXRlLCBwcm9wcy5tYXhEYXRlXSkpIHtcbiAgICAgICAgICAgIGluaXRpYWxNb250aCA9IHRvZGF5O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaW5pdGlhbE1vbnRoID0gRGF0ZVV0aWxzLmdldERhdGVCZXR3ZWVuKFtwcm9wcy5taW5EYXRlLCBwcm9wcy5tYXhEYXRlXSk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgICAgICAgZGlzcGxheU1vbnRoOiBpbml0aWFsTW9udGguZ2V0TW9udGgoKSxcbiAgICAgICAgICAgIGRpc3BsYXlZZWFyOiBpbml0aWFsTW9udGguZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgICAgIHNlbGVjdGVkRGF5LFxuICAgICAgICAgICAgdmFsdWUsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIHJlbmRlcigpIHtcbiAgICAgICAgY29uc3QgeyBjbGFzc05hbWUsIGxvY2FsZSwgbG9jYWxlVXRpbHMsIG1heERhdGUsIG1pbkRhdGUsIHNob3dBY3Rpb25zQmFyIH0gPSB0aGlzLnByb3BzO1xuICAgICAgICBjb25zdCB7IGRpc3BsYXlNb250aCwgZGlzcGxheVllYXIgfSA9IHRoaXMuc3RhdGU7XG5cbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPXtjbGFzc05hbWVzKENsYXNzZXMuREFURVBJQ0tFUiwgY2xhc3NOYW1lKX0+XG4gICAgICAgICAgICAgICAgPFJlYWN0RGF5UGlja2VyXG4gICAgICAgICAgICAgICAgICAgIGNhbkNoYW5nZU1vbnRoPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICBjYXB0aW9uRWxlbWVudD17dGhpcy5yZW5kZXJDYXB0aW9uKCl9XG4gICAgICAgICAgICAgICAgICAgIGRpc2FibGVkRGF5cz17dGhpcy5kaXNhYmxlZERheXN9XG4gICAgICAgICAgICAgICAgICAgIGVuYWJsZU91dHNpZGVEYXlzPXt0cnVlfVxuICAgICAgICAgICAgICAgICAgICBmcm9tTW9udGg9e21pbkRhdGV9XG4gICAgICAgICAgICAgICAgICAgIGluaXRpYWxNb250aD17bmV3IERhdGUoZGlzcGxheVllYXIsIGRpc3BsYXlNb250aCl9XG4gICAgICAgICAgICAgICAgICAgIGxvY2FsZT17bG9jYWxlfVxuICAgICAgICAgICAgICAgICAgICBsb2NhbGVVdGlscz17bG9jYWxlVXRpbHN9XG4gICAgICAgICAgICAgICAgICAgIG1vZGlmaWVycz17dGhpcy5wcm9wcy5tb2RpZmllcnN9XG4gICAgICAgICAgICAgICAgICAgIG9uRGF5Q2xpY2s9e3RoaXMuaGFuZGxlRGF5Q2xpY2t9XG4gICAgICAgICAgICAgICAgICAgIG9uTW9udGhDaGFuZ2U9e3RoaXMuaGFuZGxlTW9udGhDaGFuZ2V9XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkRGF5cz17dGhpcy5zZWxlY3RlZERheXN9XG4gICAgICAgICAgICAgICAgICAgIHRvTW9udGg9e21heERhdGV9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICB7c2hvd0FjdGlvbnNCYXIgPyB0aGlzLnJlbmRlck9wdGlvbnNCYXIoKSA6IG51bGx9XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHM6IElEYXRlUGlja2VyUHJvcHMpIHtcbiAgICAgICAgaWYgKG5leHRQcm9wcy52YWx1ZSAhPT0gdGhpcy5wcm9wcy52YWx1ZSkge1xuICAgICAgICAgICAgbGV0IHtkaXNwbGF5TW9udGgsIGRpc3BsYXlZZWFyLCBzZWxlY3RlZERheX0gPSB0aGlzLnN0YXRlO1xuICAgICAgICAgICAgaWYgKG5leHRQcm9wcy52YWx1ZSAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgZGlzcGxheU1vbnRoID0gbmV4dFByb3BzLnZhbHVlLmdldE1vbnRoKCk7XG4gICAgICAgICAgICAgICAgZGlzcGxheVllYXIgPSBuZXh0UHJvcHMudmFsdWUuZ2V0RnVsbFllYXIoKTtcbiAgICAgICAgICAgICAgICBzZWxlY3RlZERheSA9IG5leHRQcm9wcy52YWx1ZS5nZXREYXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgZGlzcGxheU1vbnRoLCBkaXNwbGF5WWVhciwgc2VsZWN0ZWREYXksIHZhbHVlOiBuZXh0UHJvcHMudmFsdWUgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBzdXBlci5jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcyk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHZhbGlkYXRlUHJvcHMocHJvcHM6IElEYXRlUGlja2VyUHJvcHMpIHtcbiAgICAgICAgY29uc3QgeyBkZWZhdWx0VmFsdWUsIGluaXRpYWxNb250aCwgbWF4RGF0ZSwgbWluRGF0ZSwgdmFsdWUgfSA9IHByb3BzO1xuICAgICAgICBpZiAoZGVmYXVsdFZhbHVlICE9IG51bGwgJiYgIURhdGVVdGlscy5pc0RheUluUmFuZ2UoZGVmYXVsdFZhbHVlLCBbbWluRGF0ZSwgbWF4RGF0ZV0pKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoRXJyb3JzLkRBVEVQSUNLRVJfREVGQVVMVF9WQUxVRV9JTlZBTElEKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpbml0aWFsTW9udGggIT0gbnVsbCAmJiAhRGF0ZVV0aWxzLmlzTW9udGhJblJhbmdlKGluaXRpYWxNb250aCwgW21pbkRhdGUsIG1heERhdGVdKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKEVycm9ycy5EQVRFUElDS0VSX0lOSVRJQUxfTU9OVEhfSU5WQUxJRCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobWF4RGF0ZSAhPSBudWxsXG4gICAgICAgICAgICAgICAgJiYgbWluRGF0ZSAhPSBudWxsXG4gICAgICAgICAgICAgICAgJiYgbWF4RGF0ZSA8IG1pbkRhdGVcbiAgICAgICAgICAgICAgICAmJiAhRGF0ZVV0aWxzLmFyZVNhbWVEYXkobWF4RGF0ZSwgbWluRGF0ZSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihFcnJvcnMuREFURVBJQ0tFUl9NQVhfREFURV9JTlZBTElEKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh2YWx1ZSAhPSBudWxsICYmICFEYXRlVXRpbHMuaXNEYXlJblJhbmdlKHZhbHVlLCBbbWluRGF0ZSwgbWF4RGF0ZV0pKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoRXJyb3JzLkRBVEVQSUNLRVJfVkFMVUVfSU5WQUxJRCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRpc2FibGVkRGF5cyA9IChkYXk6IERhdGUpID0+ICFEYXRlVXRpbHMuaXNEYXlJblJhbmdlKGRheSwgW3RoaXMucHJvcHMubWluRGF0ZSwgdGhpcy5wcm9wcy5tYXhEYXRlXSk7XG4gICAgcHJpdmF0ZSBzZWxlY3RlZERheXMgPSAoZGF5OiBEYXRlKSA9PiBEYXRlVXRpbHMuYXJlU2FtZURheSh0aGlzLnN0YXRlLnZhbHVlLCBkYXkpO1xuXG4gICAgcHJpdmF0ZSByZW5kZXJDYXB0aW9uKCkge1xuICAgICAgICBjb25zdCB7IG1heERhdGUsIG1pbkRhdGUgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICA8RGF0ZVBpY2tlckNhcHRpb25cbiAgICAgICAgICAgICAgICBtYXhEYXRlPXttYXhEYXRlfVxuICAgICAgICAgICAgICAgIG1pbkRhdGU9e21pbkRhdGV9XG4gICAgICAgICAgICAgICAgb25Nb250aENoYW5nZT17dGhpcy5oYW5kbGVNb250aFNlbGVjdENoYW5nZX1cbiAgICAgICAgICAgICAgICBvblllYXJDaGFuZ2U9e3RoaXMuaGFuZGxlWWVhclNlbGVjdENoYW5nZX1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW5kZXJPcHRpb25zQmFyKCkge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e0NsYXNzZXMuREFURVBJQ0tFUl9GT09URVJ9PlxuICAgICAgICAgICAgICAgIDxCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPVwicHQtbWluaW1hbCBwdC1kYXRlcGlja2VyLWZvb3Rlci1idXR0b25cIlxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXt0aGlzLmhhbmRsZVRvZGF5Q2xpY2t9XG4gICAgICAgICAgICAgICAgICAgIHRleHQ9XCJUb2RheVwiXG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgICA8QnV0dG9uXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT1cInB0LW1pbmltYWwgcHQtZGF0ZXBpY2tlci1mb290ZXItYnV0dG9uXCJcbiAgICAgICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5oYW5kbGVDbGVhckNsaWNrfVxuICAgICAgICAgICAgICAgICAgICB0ZXh0PVwiQ2xlYXJcIlxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZURheUNsaWNrID0gKF9lOiBSZWFjdC5TeW50aGV0aWNFdmVudDxIVE1MRWxlbWVudD4sIGRheTogRGF0ZSwgbW9kaWZpZXJzOiBJRGF0ZVBpY2tlckRheU1vZGlmaWVycykgPT4ge1xuICAgICAgICBsZXQgbmV3VmFsdWUgPSBkYXk7XG5cbiAgICAgICAgaWYgKHRoaXMucHJvcHMuY2FuQ2xlYXJTZWxlY3Rpb24gJiYgbW9kaWZpZXJzLnNlbGVjdGVkKSB7XG4gICAgICAgICAgICBuZXdWYWx1ZSA9IG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5wcm9wcy52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAvLyBjb21wb25lbnQgaXMgdW5jb250cm9sbGVkXG4gICAgICAgICAgICBpZiAoIW1vZGlmaWVycy5kaXNhYmxlZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRpc3BsYXlNb250aCA9IGRheS5nZXRNb250aCgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRpc3BsYXlZZWFyID0gZGF5LmdldEZ1bGxZZWFyKCk7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWREYXkgPSBkYXkuZ2V0RGF0ZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBkaXNwbGF5TW9udGgsIGRpc3BsYXlZZWFyLCBzZWxlY3RlZERheSwgdmFsdWU6IG5ld1ZhbHVlIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFtb2RpZmllcnMuZGlzYWJsZWQpIHtcbiAgICAgICAgICAgIFV0aWxzLnNhZmVJbnZva2UodGhpcy5wcm9wcy5vbkNoYW5nZSwgbmV3VmFsdWUsIHRydWUpO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhdGUudmFsdWUgIT0gbnVsbCAmJiB0aGlzLnN0YXRlLnZhbHVlLmdldE1vbnRoKCkgIT09IGRheS5nZXRNb250aCgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5pZ25vcmVOZXh0TW9udGhDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gcmVyZW5kZXIgYmFzZSBjb21wb25lbnQgdG8gZ2V0IGFyb3VuZCBidWcgd2hlcmUgeW91IGNhbiBuYXZpZ2F0ZSBwYXN0IGJvdW5kcyBieSBjbGlja2luZyBkYXlzXG4gICAgICAgICAgICB0aGlzLmZvcmNlVXBkYXRlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbXB1dGVWYWxpZERhdGVJblNwZWNpZmllZE1vbnRoWWVhcihkaXNwbGF5WWVhcjogbnVtYmVyLCBkaXNwbGF5TW9udGg6IG51bWJlcik6IERhdGUge1xuICAgICAgICBjb25zdCB7IG1pbkRhdGUsIG1heERhdGUgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgIGNvbnN0IG1heERheXNJbk1vbnRoID0gbmV3IERhdGUoZGlzcGxheVllYXIsIGRpc3BsYXlNb250aCArIDEsIDApLmdldERhdGUoKTtcbiAgICAgICAgbGV0IHsgc2VsZWN0ZWREYXkgfSA9IHRoaXMuc3RhdGU7XG5cbiAgICAgICAgaWYgKHNlbGVjdGVkRGF5ID4gbWF4RGF5c0luTW9udGgpIHtcbiAgICAgICAgICAgIHNlbGVjdGVkRGF5ID0gbWF4RGF5c0luTW9udGg7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBtYXRjaGVzIHRoZSB1bmRlcmx5aW5nIHJlYWN0LWRheS1waWNrZXIgdGltZXN0YW1wIGJlaGF2aW9yXG4gICAgICAgIGxldCB2YWx1ZSA9IG5ldyBEYXRlKGRpc3BsYXlZZWFyLCBkaXNwbGF5TW9udGgsIHNlbGVjdGVkRGF5LCAxMik7XG5cbiAgICAgICAgaWYgKHZhbHVlIDwgbWluRGF0ZSkge1xuICAgICAgICAgICAgdmFsdWUgPSBtaW5EYXRlO1xuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID4gbWF4RGF0ZSkge1xuICAgICAgICAgICAgdmFsdWUgPSBtYXhEYXRlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgaGFuZGxlTW9udGhDaGFuZ2UgPSAobmV3RGF0ZTogRGF0ZSkgPT4ge1xuICAgICAgICBjb25zdCBkaXNwbGF5TW9udGggPSBuZXdEYXRlLmdldE1vbnRoKCk7XG4gICAgICAgIGNvbnN0IGRpc3BsYXlZZWFyID0gbmV3RGF0ZS5nZXRGdWxsWWVhcigpO1xuICAgICAgICBsZXQgeyB2YWx1ZSB9ID0gdGhpcy5zdGF0ZTtcblxuICAgICAgICBpZiAodmFsdWUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIHZhbHVlID0gdGhpcy5jb21wdXRlVmFsaWREYXRlSW5TcGVjaWZpZWRNb250aFllYXIoZGlzcGxheVllYXIsIGRpc3BsYXlNb250aCk7XG4gICAgICAgICAgICBpZiAodGhpcy5pZ25vcmVOZXh0TW9udGhDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmlnbm9yZU5leHRNb250aENoYW5nZSA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBpZiBoYW5kbGVEYXlDbGljayBqdXN0IGdvdCBydW4sIGl0IG1lYW5zIHRoZSB1c2VyIHNlbGVjdGVkIGEgZGF0ZSBpbiBhIG5ldyBtb250aCxcbiAgICAgICAgICAgICAgICAvLyBzbyBkb24ndCBydW4gb25DaGFuZ2UgYWdhaW5cbiAgICAgICAgICAgICAgICBVdGlscy5zYWZlSW52b2tlKHRoaXMucHJvcHMub25DaGFuZ2UsIHZhbHVlLCBmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNldFN0YXRlV2l0aFZhbHVlSWZVbmNvbnRyb2xsZWQoeyBkaXNwbGF5TW9udGgsIGRpc3BsYXlZZWFyIH0sIHZhbHVlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZU1vbnRoU2VsZWN0Q2hhbmdlID0gKGRpc3BsYXlNb250aDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGxldCB7IHZhbHVlIH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmNvbXB1dGVWYWxpZERhdGVJblNwZWNpZmllZE1vbnRoWWVhcih2YWx1ZS5nZXRGdWxsWWVhcigpLCBkaXNwbGF5TW9udGgpO1xuICAgICAgICAgICAgVXRpbHMuc2FmZUludm9rZSh0aGlzLnByb3BzLm9uQ2hhbmdlLCB2YWx1ZSwgZmFsc2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZVdpdGhWYWx1ZUlmVW5jb250cm9sbGVkKHsgZGlzcGxheU1vbnRoIH0sIHZhbHVlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVllYXJTZWxlY3RDaGFuZ2UgPSAoZGlzcGxheVllYXI6IG51bWJlcikgPT4ge1xuICAgICAgICBsZXQgeyBkaXNwbGF5TW9udGgsIHZhbHVlIH0gPSB0aGlzLnN0YXRlO1xuXG4gICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmNvbXB1dGVWYWxpZERhdGVJblNwZWNpZmllZE1vbnRoWWVhcihkaXNwbGF5WWVhciwgZGlzcGxheU1vbnRoKTtcbiAgICAgICAgICAgIFV0aWxzLnNhZmVJbnZva2UodGhpcy5wcm9wcy5vbkNoYW5nZSwgdmFsdWUsIGZhbHNlKTtcbiAgICAgICAgICAgIGRpc3BsYXlNb250aCA9IHZhbHVlLmdldE1vbnRoKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCB7IG1pbkRhdGUsIG1heERhdGUgfSA9IHRoaXMucHJvcHM7XG4gICAgICAgICAgICBjb25zdCBtaW5ZZWFyID0gbWluRGF0ZS5nZXRGdWxsWWVhcigpO1xuICAgICAgICAgICAgY29uc3QgbWF4WWVhciA9IG1heERhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICAgICAgICAgIGNvbnN0IG1pbk1vbnRoID0gbWluRGF0ZS5nZXRNb250aCgpO1xuICAgICAgICAgICAgY29uc3QgbWF4TW9udGggPSBtYXhEYXRlLmdldE1vbnRoKCk7XG5cbiAgICAgICAgICAgIGlmIChkaXNwbGF5WWVhciA9PT0gbWluWWVhciAmJiBkaXNwbGF5TW9udGggPCBtaW5Nb250aCkge1xuICAgICAgICAgICAgICAgIGRpc3BsYXlNb250aCA9IG1pbk1vbnRoO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChkaXNwbGF5WWVhciA9PT0gbWF4WWVhciAmJiBkaXNwbGF5TW9udGggPiBtYXhNb250aCkge1xuICAgICAgICAgICAgICAgIGRpc3BsYXlNb250aCA9IG1heE1vbnRoO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXRTdGF0ZVdpdGhWYWx1ZUlmVW5jb250cm9sbGVkKHsgZGlzcGxheU1vbnRoLCBkaXNwbGF5WWVhciB9LCB2YWx1ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRTdGF0ZVdpdGhWYWx1ZUlmVW5jb250cm9sbGVkKG5ld1N0YXRlOiBJRGF0ZVBpY2tlclN0YXRlLCB2YWx1ZTogRGF0ZSkge1xuICAgICAgICBpZiAodGhpcy5wcm9wcy52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAvLyB1bmNvbnRyb2xsZWQgbW9kZSBtZWFucyB3ZSB0cmFjayB2YWx1ZSBpbiBzdGF0ZVxuICAgICAgICAgICAgbmV3U3RhdGUudmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zZXRTdGF0ZShuZXdTdGF0ZSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVDbGVhckNsaWNrID0gKCkgPT4ge1xuICAgICAgICBpZiAodGhpcy5wcm9wcy52YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsgdmFsdWU6IG51bGwgfSk7XG4gICAgICAgIH1cbiAgICAgICAgVXRpbHMuc2FmZUludm9rZSh0aGlzLnByb3BzLm9uQ2hhbmdlLCBudWxsLCB0cnVlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGhhbmRsZVRvZGF5Q2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gbmV3IERhdGUoKTtcbiAgICAgICAgY29uc3QgZGlzcGxheU1vbnRoID0gdmFsdWUuZ2V0TW9udGgoKTtcbiAgICAgICAgY29uc3QgZGlzcGxheVllYXIgPSB2YWx1ZS5nZXRGdWxsWWVhcigpO1xuICAgICAgICBjb25zdCBzZWxlY3RlZERheSA9IHZhbHVlLmdldERhdGUoKTtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMudmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGRpc3BsYXlNb250aCwgZGlzcGxheVllYXIsIHNlbGVjdGVkRGF5LCB2YWx1ZSB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoeyBkaXNwbGF5TW9udGgsIGRpc3BsYXlZZWFyLCBzZWxlY3RlZERheSB9KTtcbiAgICAgICAgfVxuICAgICAgICBVdGlscy5zYWZlSW52b2tlKHRoaXMucHJvcHMub25DaGFuZ2UsIHZhbHVlLCB0cnVlKTtcbiAgICB9XG59XG5cbmV4cG9ydCBjb25zdCBEYXRlUGlja2VyRmFjdG9yeSA9IFJlYWN0LmNyZWF0ZUZhY3RvcnkoRGF0ZVBpY2tlcik7XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
